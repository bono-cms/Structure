<?php

use Cms\View\Icon;
use Krystal\Form\Element;
use Krystal\Text\TextUtils;
use Krystal\Stdlib\ArrayUtils;
use Structure\Collection\FieldTypeCollection;
use Structure\View\RepeaterViewModel;

?>

<div class="row">
    <div class="col-lg-7">
        <div class="card">
            <h3 class="mb-4">
                <i class="fas fa-table"></i> <?= $this->translate('Records'); ?> <small class="text-muted">(<?= count($rows); ?>)</small>
            </h3>

            <?php $this->loadPartial('table', [
                'rows' => $rows,
                'rowAttributes' => [
                    'class' => function($row) use ($repeaterId){
                        return $row['repeater_id'] == $repeaterId ? 'table-info' : null;
                    }
                ],
                'columns' => RepeaterViewModel::createColumns($rows),
                'actions' => [
                    function($row) use ($repeater){
                        return Icon::edit(
                            $this->url('Structure:Admin:Repeater@editAction', $repeater['collection_id'], $row['repeater_id']),
                            $this->translate('Edit this record')
                        );
                    },
                    function($row){
                        return Icon::remove(
                            $this->url('Structure:Admin:Repeater@deleteAction', $row['repeater_id']),
                            $this->translate('Delete this record')
                        );
                    }
                ]
            ]); ?>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card">
            <form data-group="collection" autocomplete="off">
                <h3 class="mb-4">
                    <i class="fas fa-pencil-alt"></i> <?= $this->translate(!isset($repeater['id']) ? 'Add new record' : 'Update the record'); ?>
                </h3>

                <?= Element::hidden('repeater[id]', isset($repeater['id']) ? $repeater['id'] : null); ?>
                <?= Element::hidden('repeater[collection_id]', $repeater['collection_id']); ?>

                <?php foreach ($fields as $field): ?>
                <?php
                    $name = sprintf('record[%s]', $field['id']);
                    $attributes = ['class' => 'form-control', 'placeholder' => $field['hint']];
                    $value = isset($field['value']) ? $field['value'] : null;
                    $list = FieldTypeCollection::isList($field['type']) ? TextUtils::breakString($field['hint']) : [];
                ?>

                <div class="form-group">
                    <label class="control-label"><?= $field['name']; ?></label>
                    
                    <!-- Text -->
                    <?php if ($field['type'] == FieldTypeCollection::FIELD_TEXT): ?>
                    <?= Element::text($name, $value, $attributes); ?>
                    <?php endif; ?>

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_TEXTAREA): ?>
                    <?= Element::textarea($name, $value, $attributes); ?>
                    <?php endif; ?>

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_WYSIWYG): ?>
                    <?= Element::textarea($name, $value, ['data-wysiwyg' => 'true']); ?>
                    <?php endif; ?>
                    <!-- End of Text -->

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_NUMBER): ?>
                    <?= Element::number($name, $value, $attributes); ?>
                    <?php endif; ?>

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_EMAIL): ?>
                    <?= Element::email($name, $value, $attributes); ?>
                    <?php endif; ?>
                    
                    <!-- Date and time -->
                    <?php if ($field['type'] == FieldTypeCollection::FIELD_DATE): ?>
                    <?= Element::date($name, $value, $attributes); ?>
                    <?php endif; ?>

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_TIME): ?>
                    <?= Element::time($name, $value, $attributes); ?>
                    <?php endif; ?>

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_DATETIME): ?>
                    <?= Element::datetime($name, $value, $attributes); ?>
                    <?php endif; ?>
                    <!-- End of Date and time -->

                    <!-- Lists -->
                    <?php if ($field['type'] == FieldTypeCollection::FIELD_SELECT): ?>
                    <?= Element::select($name, ArrayUtils::valuefy($list), $value, $attributes); ?>
                    <?php endif; ?>

                    <!-- Checkbox or radio -->
                    <?php if ($field['type'] == FieldTypeCollection::FIELD_CHECKBOX || $field['type'] == FieldTypeCollection::FIELD_RADIO): ?>
                    <?php foreach ($list as $item): ?>
                    <div class="form-check">
                      <?php $id = sprintf('item-%s', md5($item)); ?>

                      <!-- Checkbox -->
                      <?php if ($field['type'] == FieldTypeCollection::FIELD_CHECKBOX): ?>
                      <?= Element::checkbox($name, $item == $value, ['class' => 'form-check-input', 'id' => $id, 'value' => $item]); ?>
                      <?php endif; ?>

                      <!-- Radio -->
                      <?php if ($field['type'] == FieldTypeCollection::FIELD_RADIO): ?>
                      <?= Element::radio($name, $item, $item == $value, ['class' => 'form-check-input', 'id' => $id, 'value' => $item]); ?>
                      <?php endif; ?>

                      <label class="form-check-label" for="<?= $id; ?>">
                        <?= $item; ?>
                      </label>
                    </div>
                    <?php endforeach; ?>
                    <?php endif; ?>
                    <!-- End of Checkbox and radios -->

                    <?php if ($field['type'] == FieldTypeCollection::FIELD_DATALIST): ?>
                    <?= Element::datalist($name, $value, $list, ['class' => 'form-control']); ?>
                    <?php endif; ?>
                    <!-- End of Lists -->
                </div>
                <?php endforeach; ?>

                <!-- Static attributes -->
                <div class="form-group">
                    <label class="control-label"><?= $this->translate('Hidden'); ?></label>
                    <?= Element::checkbox('repeater[hidden]', isset($repeater['hidden']) ? $repeater['hidden'] : null); ?>
                </div>

                <div class="form-group">
                    <label class="control-label"><?= $this->translate('Sorting order'); ?></label>
                    <?= Element::number('repeater[order]', isset($repeater['order']) ? $repeater['order'] : null, ['class' => 'form-control']); ?>
                </div>
                <!-- ..End of static attributes -->

                <?php $this->loadPartial('actions', [
                    'new' => !$field['id'],
                    'add' => [$this->url('Structure:Admin:Repeater@addAction', $field['id'])],
                    'edit' => [$this->url('Structure:Admin:Repeater@editAction', '')],
                    'save' => 'Structure:Admin:Repeater@saveAction',
                    'cancel' => [$this->url('Structure:Admin:Repeater@indexAction', $field['collection_id'])]
                ]); ?>
            </form>
        </div>
    </div>
</div>